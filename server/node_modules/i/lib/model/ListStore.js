!function () {
    var ListStore = function ListStore() {};

    ListStore.prototype.init = function init(db) {
        this.db = db;
    };

    ListStore.prototype.get = function get(pk, cb) {
        var self = this;
        this.db.hkeys(this.abb + pk, function(err, data) {
            if (err) return cb(new I.Exception(10107, err));
            var listModelClass = self.getListModel();
            // empty list
            if (data.length === 0) {
                var list = new listModelClass(pk);
                cb(null, list);
                return;
            }

            var modelList = {};
            var retrievedCount = 0;
            // fill elements
            data.forEach(function(v) {
                self.getChildStore().get(v, function(err, model) {
                    modelList[v] = model;
                    ++retrievedCount;
                    if (data.length === retrievedCount) {
                        var list = new listModelClass(pk, modelList);
                        cb(null, list);
                    }
                });
            });
        });
    };

    ListStore.prototype.del = function del(list, cb) {
        if (list instanceof this.getListModel() === false) return cb(new I.Exception(10108));
        var self = this;

        if (list.list.length === 0) {
            cb(null, list);
            return
        }

        var dbMulti = this.db.multi();
        // del list index
        dbMulti.del(this.abb + list.getPK());
        
        // del hash
        list.getKeys().forEach(function(v) {
            dbMulti.del(self.getChildStore().abb + v);
        });

        dbMulti.exec(function(err, results) {
            if (err) return cb(new I.Exception(10116, err));
            list.reset();
            cb(null, list);
        });
    };

    ListStore.prototype.update = function update(list, cb) {
        if (list instanceof this.getListModel() === false) return cb(new I.Exception(10138));
        var self = this;
        var util = I.Util;
        var dbMulti = this.db.multi();

        var exec = function exec() {
            dbMulti.exec(function(err, results) {
                if (err) return cb(new I.Exception(10117, err));
                cb(null, list);
            });
        };

        var childStore = this.getChildStore();
        // del
        list.toDelList.forEach(function(child) {
            var pk = child.getPK();
            dbMulti.del(childStore.abb + pk);
            dbMulti.hdel(self.abb + list.getPK(), pk);
            list.unset(pk);
        });
        list.toDelList = [];

        // update
        list.toUpdateList.forEach(function(child) {
            var toDB = child.toUpdate(true);
            if (util.getLength(toDB) === 0) return;
            dbMulti.hmset(childStore.abb + child.getPK(), toDB);
        });
        list.toUpdateList = [];

        // add
        var toAddListLength = list.toAddList.length;
        if (toAddListLength === 0) return exec();

        var addedCount = 0;
        list.toAddList.forEach(function(v) {
            childStore.add(v, function(err, child) {
                list.set(child);
                ++addedCount;
                dbMulti.hset(self.abb + list.getPK(), child.getPK(), 1);
                if (toAddListLength === addedCount) {
                    list.toAddList = [];
                    exec();
                }
            });
        });
    };

    ListStore.prototype.updateSync = function updateSync(list, cb) {
        cb = cb || function() {};
        var store = this.getListModel();
        if (list instanceof this.getListModel() === false) return cb(new I.Exception(10142));
        if (list.toDelSyncList.length === 0 && list.toUpdateSyncList.length === 0 && list.toAddSyncList.length === 0) return cb(null);
        var self = this;
        var util = I.Util;
        var dbMulti = this.db.multi();

        var childModel = this.getChildModel();
        var childStore = this.getChildStore();
        // del
        list.toDelSyncList.forEach(function(child) {
            var pk = child.getPK();
            dbMulti.del(childStore.abb + pk);
            dbMulti.hdel(self.abb + list.getPK(), pk);
        });
        list.toDelSyncList = [];

        // update
        list.toUpdateSyncList.forEach(function(index) {
            var child = list.get(index);
            var toDB = child.toUpdate(true);
            if (util.getLength(toDB) === 0) return;
            dbMulti.hmset(childStore.abb + child.getPK(), toDB);
            child.resetUpdateList();
        });
        list.toUpdateSyncList = [];

        // add
        list.toAddSyncList.forEach(function(index) {
            var child = list.get(index);
            var toDB = child.toAdd();
            dbMulti.hmset(childStore.abb + index, toDB);
            dbMulti.hset(self.abb + list.getPK(), child.getPK(), 1);
        });
        list.toAddSyncList = [];

        dbMulti.exec(function(err, results) {
            if (err) return cb(new I.Exception(10123, err));
            cb(err, results);
        });
    };

    ListStore.prototype.sync = function sync(list, cb) {
        cb = cb || function() {};
        if (list.tagDelSync) {
            this.del(list, cb);
        } else {
            this.updateSync(list, cb);
        }
    };

    I.Util.require('ListStore', 'Models', ListStore);
}();
