!function () {
    var ModelStore = function ModelStore() {};

    ModelStore.prototype.init = function init(db) {
        this.db = db;
    };

    ModelStore.prototype.get = function get(pk, cb) {
        var self = this;
        var dbMulti = this.db.multi();
        dbMulti.hkeys(this.abb + pk);
        dbMulti.hvals(this.abb + pk);
        dbMulti.exec(function(err, results) {
            if (err) return cb(new I.Exception(10103, err));

            var keys = results[0];
            var data = results[1];

            // convert '1' to 1
            var array = [];
            var util = I.Util;
            for (var i = 0; i < data.length; ++i) {
                array[keys[i]] = util.isUInt(data[i]) ? parseInt(data[i]) : data[i];
            }

            var modelClass = self.getModel();
            var model = new modelClass(array);
            cb(null, model);
        });
    };

    ModelStore.prototype.add = function add(model, cb) {
        if (model instanceof this.getModel() === false) return cb(new I.Exception(10101, err));
        cb = cb || function() {};
        var self = this;
        if (this.pkAutoIncrement) {
            this.db.incr(I.Const.Frame.GLOBAL_KEY_PREFIX + this.abb, function(err, id) {
                if (err) return cb(new I.Exception(10104, err));
                self.addHash(model, cb, id);
            });
        } else {
            this.addHash(model, cb);
        }
    };

    ModelStore.prototype.addHash = function addHash(model, cb, id) {
        if (id === undefined) {
            var key = model.getPK();
        } else {
            model.setPK(id);
            var key = id;
        }
        var toDB = model.toAdd();
        if (I.Util.getLength(toDB) === 0) return cb(new I.Exception(10105));

        this.db.hmset(this.abb + key, toDB, function(err, result) {
            if (err) return cb(new I.Exception(10111, err));
            model.resetUpdateList();
            cb(null, model, result);
        });
    };

    ModelStore.prototype.del = function del(input, cb) {
        var key;
        if (I.Util.isString(input)) {
            key = this.abb + input;
        } else if (input instanceof this.getModel()){
            key = this.abb + input.getPK();
        } else {
            return cb(new I.Exception(10126));
        }

        this.db.del(key, function(err, result) {
            if (err) return cb(new I.Exception(10110, err));
            cb(null, result);
        });
    };

    ModelStore.prototype.update = function update(model, cb) {
        if (model instanceof this.getModel() === false) return cb(new I.Exception(10106, err));
        var toDB = model.toUpdate(true);
        // nothing to update
        if (I.Util.getLength(toDB) === 0) return cb(null, model);

        this.db.hmset(this.abb + model.getPK(), toDB, function(err, result) {
            if (err) return cb(new I.Exception(10119, err));
            model.resetUpdateList();
            cb(null, model);
        });
    };

    ModelStore.prototype.sync = function sync(model, cb) {
        cb = cb || function() {};
        if (model.tagAddSync) {
            this.addHash(model, cb, model.getPK());
        } else if (model.tagDelSync) {
            this.del(model, cb);
        } else {
            this.update(model, cb);
        }
    };

    I.Util.require('ModelStore', 'Models', ModelStore);
}();
