var fs = require('fs');
var path = require('path');
require('./Util.js');
var serverORMs = require(APP_ABS_PATH + '/config/orm.js').orms;
var clientORMs = require(STA_ABS_PATH + '/js/config/orm.js').orms;

var Loader = function() {};

Loader.prototype.loadCore = function loadCore() {
    // redis
    var env = require(APP_ABS_PATH + '/config/env.js').env;
    global.db = require('redis').createClient(env.RDB.PORT, env.RDB.HOST);
    global.Q = require('q');

    require('./ConnectionPool.js');
    require('./Const.js');
    require('./DataPool.js');
    require('./ex/Exception.js');
    require('./ex/ExceptionCodes.js');
    require('./Route.js');

    // models
    require('./model/PK.js');
    require('./model/Model.js');
    require('./model/List.js');
    require('./rdb/PKRedisStore.js');
    require('./rdb/ModelRedisStore.js');
    require('./rdb/ListRedisStore.js');
};

Loader.prototype.loadApp = function loadApp(appDir) {
    require(I_ABS_PATH + '/lib/model/Maker.js');
    I.Maker.createServerFiles(serverORMs, APP_ABS_PATH + '/model');
    I.Maker.createClientFiles(clientORMs, STA_ABS_PATH + '/js/model');
    this.dir = appDir;

    this.loadDir('Ctrl', '/ctrl');
    this.loadDir('Const', '/const');
    this.loadDir('Lib', '/lib');
    this.loadEx();

    this.loadModelBaseClasses();
    this.loadModels('Models', '/model');
};

Loader.prototype.loadModelBaseClasses = function loadModelBaseClasses() {
    I.Maker.makeModelBaseClasses(serverORMs);
    this.loadMemoryModelClasses(I.Maker.getClasses());
};

Loader.prototype.loadMemoryModelClasses = function loadMemoryClasses(classes) {
    for (var name in classes) {
        I.Models[name] = classes[name];
    }
};

Loader.prototype.loadClass = function loadClass(type, Class, name) {
    if (I[type] === undefined) I[type] = {};

    if (I[type][name]) throw new I.Exception(10003);
    I[type][name] = Class;
};

Loader.prototype.loadDir = function loadDir(type, dirname) {
    var dir = this.dir + dirname;

    var files = fs.readdirSync(dir);
    files.forEach(function(filename) {
        var name = path.basename(filename, '.js');
        var Class = require(dir + '/' + filename)[name];
        this.loadClass(type, Class, name);
    }.bind(this));
};

Loader.prototype.loadModels = function loadModels(type, dirname) {
    var dir = this.dir + dirname;

    var files = fs.readdirSync(dir);
    files.forEach(function(filename) {
        var name = path.basename(filename, '.js');
        var Class = require(dir + '/' + filename)[name];
    }.bind(this));
};

Loader.prototype.loadEx = function loadEx() {
    var exFullPath = this.dir + '/config/ex.js';
    var ex = require(exFullPath).ex;
    for (var i in ex) {
        I.ExceptionCodes[i] = ex[i];
    }
};

exports.Loader = new Loader();
