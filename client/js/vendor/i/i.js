!function(){var Util={upperCaseFirst:function upperCaseFirst(string){return string[0].toUpperCase()+string.substr(1)},max:function max(object){if(Array.isArray(object))var array=object;else if(typeof object==="object")var array=this.getKeys(object);else throw new I.Exception(10209);return Math.max.apply(Math,array)},min:function min(object){if(Array.isArray(object))var array=object;else if(typeof object==="object")var array=this.getKeys(object);else throw new I.Exception(10210);return Math.min.apply(Math,
array)},getKeys:function getKeys(object){var keys=[];for(var i in object)keys.push(i);return keys},getLength:function getLength(object){if(Array.isArray(object))return object.length;else if(typeof object==="object"){var i=0;for(var h in object)++i;return i}else throw new I.Exception(10201);},last:function last(object){if(Array.isArray(object))return object[object.length-1];else if(typeof object==="object"){var length=this.getLength(object);var i=0;for(var h in object){if(i===length-1)return object[h];
++i}}else throw new I.Exception(10202);},valueExist:function valueExist(value,object){if(Array.isArray(object))return object.indexOf(value)!==-1;else if(typeof object==="object"){for(var h in object)if(object[h]===value)return true;return false}else throw new I.Exception(10206);},uniqueValue:function uniqueValue(object){var exists=[];var value;if(Array.isArray(object)){var result=[];for(var i=0;i<object.length;++i){value=object[i];if(exists.indexOf(value)!=-1)continue;exists.push(value);result.push(value)}}else if(typeof object===
"object"){var result={};for(var i in object){value=object[i];if(exists.indexOf(value)!=-1)continue;exists.push(value);result[i]=value}}else throw new I.Exception(10208);return result},merge:function(a,b){var m={};for(var i in a)m[i]=a[i];for(var j in b){if(m[j]!==undefined)throw new I.Exception(10211);m[j]=b[j]}return m},isUInt:function isUInt(val){var mid=parseInt(val);return mid==val&&mid>=0},isInt:function isInt(val){return parseInt(val)==val},isNumber:function isNumber(val){return!isNaN(parseFloat(val))&&
isFinite(val)},isArray:function isArray(array){return Array.isArray(array)},isHash:function isHash(hash){return typeof hash==="object"},isString:function isString(string){return typeof string==="string"},isEmpty:function isEmpty(val){return val===""},isJSON:function isJSON(json){try{JSON.parse(json)}catch(e){return false}return true},getTimestamp:function getTimestamp(time){var stamp=this.getMicroTimestamp(time);return parseInt(stamp/1E3)},getMicroTimestamp:function getMicroTimestamp(time){if(time){var stamp=
Date.parse(time);if(!stamp)throw new I.Exception(10251);return stamp}return Date.now()},getTime:function getTime(time){if(time===undefined)var d=new Date;else if(this.isUInt(time))var d=new Date(parseInt(time)*1E3);else var d=time;var hour=this.fill0(d.getHours());var minute=this.fill0(d.getMinutes());var second=this.fill0(d.getSeconds());var month=this.fill0(d.getMonth()+1);var date=this.fill0(d.getDate());var year=d.getFullYear();return year+"-"+month+"-"+date+" "+hour+":"+minute+":"+second},fill0:function(s){return s.toString().length===
1?"0"+s:s},printError:function printError(error){console.log(error.message+":",I.ExceptionCodes[error.message])},random:function random(start,end){var n=end-start;return start+Math.floor(Math.random()*n)},getElementByProbability:function getElementByProbability(probabilityList){if(!this.isHash(probabilityList))throw new I.Exception(10203);var all=0;for(var i in probabilityList)if(probabilityList[i]==0)delete probabilityList[i];else all+=probabilityList[i];if(all===0)throw new I.Exception(10204);var seed=
this.random(1,all);var sum=0;for(var i in probabilityList){sum+=probabilityList[i];if(seed<=sum)return i}throw new I.Exception(10205);},createFn:function createFn(name,param){var paramString="";if(Array.isArray(param)&&param.length>0)paramString=param.join(", ");var fn=new Function("return function "+name+" ("+paramString+") {};");return fn()},define:function define(proto,functions,writable,enumerable,configurable){writable=writable||false;enumerable=enumerable||false;configurable=configurable||false;
for(var i in functions)Object.defineProperty(proto,i,{value:functions[i],writable:writable,enumerable:enumerable,configurable:configurable})},require:function require(name,path,object){var field;if(this.isBrowser())field=window;else field=global;if(!field.I)field.I={};if(path){if(!field.I[path])field.I[path]={};field.I[path][name]=object}else field.I[name]=object},_isBrowser:null,isBrowser:function(){if(this._isBrowser!==null)return this._isBrowser;var field;try{field=global;this._isBrowser=false}catch(e){this._isBrowser=
true}return this._isBrowser},isChecked:function isChecked(el){return $(el).attr("checked")?1:0}};Util.require("Util","",Util)}();!function(){var Const={Frame:{GLOBAL_KEY_PREFIX:"I-GK-"},IDB:{PK_TABLE:"I-PK",LIST_COLUMN_NAME:"LISTID"}};I.Util.require("Const","",Const)}();!function(){var LOG_TYPE={3:"ERR",4:"WARNING",5:"NOTICE",6:"INFO",7:"DEBUG"};var LOG_COLOR={3:"red",4:"orange",5:"blue",6:"green",7:"grey"};for(var i=3;i<=7;++i)!function(i){I.Util.require("l"+i,"",function(){if(I.env.APP.LOG_LEVEL<i)return;var args=Array.prototype.slice.call(arguments);args.unshift("color: "+LOG_COLOR[i]+"; font-weight: bold;");args.unshift("%c"+LOG_TYPE[i]+":");console.log.apply(console,args)})}(i)}();!function(){var Exception=function Exception(code){this.code=code;this.message=I.ExceptionCodes[code]};I.Util.require("Exception","",Exception)}();!function(){var ExceptionCodes={10001:"Invalid object type when making classes.",10002:"Model abb exists when making classes.",10101:"Wrong child add to list.",10102:"Invalid model name.",10103:"Error when retrieve data from db.",10104:"Error when get global key from db.",10105:"Cannot set empty hash to db.",10106:"Wrong child update to list.",10107:"Error when retrieve list from db.",10108:"Wrong list to del.",10109:"Wrong pk set to db.",10110:"Error when del model from db.",10111:"Error when add hash to db.",
10112:"Invalid child for list when remove object.",10113:"Invalid pk for list when get object index.",10114:"Invalid child for list when del object.",10115:"Invalid child for list when update object.",10116:"Error when del list from db.",10117:"Error when update list from db.",10118:"Init list must set pk.",10119:"Error when update hash to db.",10120:"Child addSync to list, child has no pk.",10121:"Wrong pk unset to db.",10122:"Error when set pk to db.",10123:"Error when updateSync list to db.",10124:"Error when unset pk to db.",
10125:"Error when get pk from db.",10126:"Invalid model when del model from db.",10127:"Invalid child model when add model to list.",10128:"Invalid child model when del model to list.",10129:"Child not exists in this list when del it.",10130:"Invalid child model when update model to list.",10131:"Child not exists in this list when update it.",10132:"Child has no pk when set it into list.",10133:"Child has no pk when unset it from list.",10134:"Pk is not UInt when setPK to list.",10135:"Invalid child model when addSync model to list.",
10136:"Invalid child model when delSync model from list.",10137:"Child not exists in this list when delSync it.",10136:"Invalid child model when updateSync model from list.",10137:"Child not exists in this list when updateSync it.",10138:"Invalid list model when update list to db.",10139:"Invalid child model when updateSync to list.",10140:"Child exists when add to list.",10141:"Child exists when addSync to list.",10142:"Invalid list model when updateSync list to db.",10201:"Invalid object when get length.",
10202:"Invalid object when get last element.",10203:"Invalid hash when get element by probabilityList.",10204:"Invalid empty probabilityList when get element by probabilityList.",10205:"Cannot get any element when get element by probabilityList.",10206:"Invalid object when test value exist.",10207:"Invalid object when get last index.",10208:"Invalid object when unique.",10209:"Invalid object when max.",10210:"Invalid object when min.",10211:"Key conflict when merge object.",10251:"Invalid time to convert to timestamp.",
10301:"Invalid request.",10302:"Wrong parameter type length of controller config.",10303:"Parameter cannot be empty.",10304:"Wrong parameter allow type.",10305:"Parameter is not int.",10306:"Parameter is not string.",10307:"Parameter is not array.",10308:"Parameter is not hash map.",10309:"Wrong parameter data type.",10401:"LogicController: logic function not exporter all values that needed.",20001:"Wrong pk set to IndexedDB.",20002:"Wrong pk unset to IndexedDB.",20003:"Wrong model set to IndexedDB.",
20004:"Wrong input unset to IndexedDB.",20005:"Wrong list update to IndexedDB.",20006:"Wrong list del to IndexedDB."};I.Util.require("ExceptionCodes","",ExceptionCodes)}();!function(){var IndexedDB=function(name,version){this.db=null;this.name=name;this.version=version;this.successEvents=[];this.upgradeEvents=[];this.onerror=function(){};var req=indexedDB.open(name,version);req.onupgradeneeded=function(e){I.l6("IndexedDB Upgraded");var db=e.target.result;e.target.transaction.onerror=this.onerror;this.onupgradeneeded(db)}.bind(this);req.onsuccess=function(e){I.l6("IndexedDB Opened");this.db=e.target.result;this.onsuccess(this.db)}.bind(this)};IndexedDB.prototype.regSuccessEvent=
function regSuccessEvent(fn){this.successEvents.push(fn)};IndexedDB.prototype.regUpgradeEvent=function regUpgradeEvent(fn){this.upgradeEvents.push(fn)};IndexedDB.prototype.onsuccess=function onsuccess(db){for(var i=0;i<this.successEvents.length;++i)this.successEvents[i](db)};IndexedDB.prototype.onupgradeneeded=function onupgradeneeded(db){for(var i=0;i<this.upgradeEvents.length;++i)this.upgradeEvents[i](db)};IndexedDB.prototype.get=function get(table,key,cb){var trans=this.db.transaction([table],
"readonly");trans.onerror=this.onerror;var req=trans.objectStore(table).get(key);req.onsuccess=function(){cb(req.result)};req.onerror=this.onerror};IndexedDB.prototype.getList=function getList(table,listId,cb){var trans=this.db.transaction([table],"readonly");trans.onerror=this.onerror;var store=trans.objectStore(table);var index=store.index(I.Const.IDB.LIST_COLUMN_NAME);var results=[];var cursorReq=index.openCursor(listId);cursorReq.onsuccess=function(e){var cursor=cursorReq.result;if(cursor){var req=
store.get(cursor.primaryKey);req.onsuccess=function(){results.push(req.result)};cursor.continue()}};trans.oncomplete=function(){cb(results)}};IndexedDB.prototype.set=function set(table,obj,cb){cb=cb||function(){};var trans=this.db.transaction([table],"readwrite");trans.onerror=this.onerror;var req=trans.objectStore(table).put(obj);req.onsuccess=cb;req.onerror=this.onerror};IndexedDB.prototype.del=function del(table,key,cb){cb=cb||function(){};var trans=this.db.transaction([table],"readwrite");trans.onerror=
this.onerror;var req=trans.objectStore(table).delete(key);req.onsuccess=cb;req.onerror=this.onerror};IndexedDB.prototype.delList=function delList(table,listId,cb){var trans=this.db.transaction([table],"readwrite");trans.onerror=this.onerror;var store=trans.objectStore(table);var index=store.index(I.Const.IDB.LIST_COLUMN_NAME);var cursorReq=index.openCursor(listId);cursorReq.onsuccess=function(e){var cursor=cursorReq.result;if(cursor){var req=store.delete(cursor.primaryKey);cursor.continue()}};trans.oncomplete=
function(){cb()}};IndexedDB.prototype.resetTable=function resetTable(db,table,keyPath,index,indexUnique){if(db.objectStoreNames.contains(table))db.deleteObjectStore(table);var objectStore=db.createObjectStore(table,{keyPath:keyPath});if(index!==undefined)objectStore.createIndex(index,index,{unique:indexUnique})};I.Util.require("IndexedDB","Models",IndexedDB)}();!function(){var PKIndexedDBStore=function(){};PKIndexedDBStore.prototype.init=function init(db){this.db=db};PKIndexedDBStore.prototype.get=function get(cb){this.db.get(I.Const.IDB.PK_TABLE,this.modelName+"PK",function(obj){var pkClass=this.getModel();if(obj===undefined)var pk=new pkClass;else var pk=new pkClass(obj.pk);cb(pk)}.bind(this))};PKIndexedDBStore.prototype.set=function set(pk,cb){cb=cb||function(){};if(pk instanceof this.getModel()===false)throw new I.Exception(20001);if(pk.updated===false)return cb();
this.db.set(I.Const.IDB.PK_TABLE,{name:pk.className,pk:pk.get()},function(){pk.updated=false;cb()})};PKIndexedDBStore.prototype.unset=function unset(pk,cb){cb=cb||function(){};if(pk instanceof this.getModel()===false)throw new I.Exception(20002);this.db.del(I.Const.IDB.PK_TABLE,this.modelName+"PK",cb)};I.Util.require("PKIndexedDBStore","Models",PKIndexedDBStore)}();!function(){var ModelIndexedDBStore=function(){};ModelIndexedDBStore.prototype.init=function init(db){this.db=db};ModelIndexedDBStore.prototype.get=function get(pk,cb){this.db.get(this.modelName,pk,function(data){var modelClass=this.getModel();var model=new modelClass;if(data!==undefined)model.fromArray(data,true);cb(model)}.bind(this))};ModelIndexedDBStore.prototype.add=function add(model,cb){if(model instanceof this.getModel()===false)throw new I.Exception(20003);cb=cb||function(){};this.db.set(this.modelName,
model.toArray(),function(){model.reset();cb()})};ModelIndexedDBStore.prototype.del=function del(input,cb){var key;if(I.Util.isString(input)||I.Util.isInt(input))key=input;else if(input instanceof this.getModel())key=input.getPK();else throw new I.Exception(20004);cb=cb||function(){};this.db.del(this.modelName,key,cb)};I.Util.require("ModelIndexedDBStore","Models",ModelIndexedDBStore)}();!function(){var ListIndexedDBStore=function(){};ListIndexedDBStore.prototype.init=function init(db){this.db=db};ListIndexedDBStore.prototype.get=function get(id,cb){this.db.getList(this.childModelName,id,function(data){var listClass=this.getListModel();var modelClass=this.getChildModel();var list=new listClass(id);data.forEach(function(n){var child=new modelClass;child.fromArray(n,true);list.set(child)});cb(list)}.bind(this))};ListIndexedDBStore.prototype.update=function update(list,cb){if(list instanceof
this.getListModel()===false)throw new I.Exception(20005);cb=cb||function(){};var listColumnName=I.Const.IDB.LIST_COLUMN_NAME;var results={toDel:list.toDelList.length,toUpdate:list.toUpdateList.length,toAdd:list.toAddList.length,delDone:0,updateDone:0,addDone:0};var allDone=function allDone(){if(results.delDone===results.toDel&&results.updateDone===results.toUpdate&&results.addDone===results.toAdd)cb()};list.toDelList.forEach(function(child){var pk=child.getPK();this.db.del(this.childModelName,pk,
function(){results.delDone=results.delDone+1;allDone()});list.unset(pk)}.bind(this));list.toDelList=[];list.toUpdateList.forEach(function(child){var obj=child.toArray();obj[listColumnName]=list.getPK();this.db.set(this.childModelName,obj,function(){results.updateDone=results.updateDone+1;child.reset();allDone()})}.bind(this));list.toUpdateList=[];list.toAddList.forEach(function(child){var obj=child.toArray();obj[listColumnName]=list.getPK();this.db.set(this.childModelName,obj,function(){results.addDone=
results.addDone+1;allDone();child.reset();list.set(child)})}.bind(this));list.toAddList=[]};ListIndexedDBStore.prototype.del=function del(list,cb){if(list instanceof this.getListModel()===false)throw new I.Exception(20006);cb=cb||function(){};this.db.delList(this.childModelName,list.getPK(),cb)};I.Util.require("ListIndexedDBStore","Models",ListIndexedDBStore)}();!function(){var PK=function PK(){};var functions={init:function init(pk){var attrs={updated:false,tagDelSync:false,pk:0};I.Util.define(this,attrs,true);this.pk=parseInt(pk)||0},set:function set(pk){this.pk=parseInt(pk);this.updated=true},get:function get(){return this.pk},incr:function incr(val){val=val||1;var newVal=this.get()+val;this.set(newVal);return newVal},reset:function reset(){this.set(0)},markDelSync:function markDelSync(){this.tagDelSync=true},backup:function backup(){return{type:"PK",
className:this.className,pk:this.get()}},restore:function restore(bak){this.set(bak.pk)},restoreSync:function restoreSync(bak){this.set(bak.pk)}};I.Util.define(PK.prototype,functions);I.Util.require("PK","Models",PK)}();!function(){var Model=function Model(){};var functions={init:function init(args){var attrs={args:[],updateList:[],tagAddSync:false,tagDelSync:false};I.Util.define(this,attrs,true);this.reset();if(Array.isArray(args))args.forEach(function(val,i){this.args[i]=val}.bind(this));else for(var i=0;i<this.column.length;++i)this.args[i]=""},reset:function reset(){this.updateList=new Array(this.column.length);this.tagAddSync=false;this.tagDelSync=false},setPK:function setPK(val){this[this.pk]=val},getPK:function getPK(){return this[this.pk]},
clone:function clone(){return new this.constructor(this.args)},toAdd:function toAdd(filterOn){var self=this;var toAdd=[];this.args.forEach(function(v,i){if(filterOn&&self.column[i].toAdd)return;toAdd[i]=v.toString()});return toAdd},toUpdate:function toUpdate(filterOn){var self=this;var toDB={};this.updateList.forEach(function(v,i){if(filterOn&&self.column[i].toUpdate)return;if(v===1)toDB[i]=self.args[i].toString()});return toDB},toAbbArray:function toAbbArray(filterOn){var self=this;var toAbbArray=
{};this.args.forEach(function(v,i){if(filterOn&&self.column[i].toAbb)return;toAbbArray[self.column[i].abb]=v});return toAbbArray},toArray:function toArray(filterOn){var self=this;var toArray={};this.args.forEach(function(v,i){if(filterOn&&self.column[i].toArray)return;toArray[self.column[i].full]=v});return toArray},toAbbDiff:function toAbbDiff(filterOn){var self=this;var toAbbDiff={};this.updateList.forEach(function(v,i){if(filterOn&&self.column[i].toAbb)return;if(v===1)toAbbDiff[self.column[i].abb]=
self.args[i]});return toAbbDiff},toArrayDiff:function toArrayDiff(filterOn){var self=this;var toArrayDiff={};this.updateList.forEach(function(v,i){if(filterOn&&self.column[i].toArray)return;if(v===1)toArrayDiff[self.column[i].full]=self.args[i]});return toArrayDiff},fromAbbArray:function fromAbbArray(data,reset){var full;for(var abb in data){full=this.abbMap[abb].full;this[full]=data[abb]}if(reset)this.reset()},fromArray:function fromArray(data,reset){for(var full in data)this[full]=data[full];if(reset)this.reset()},
markAddSync:function markAddSync(){this.tagAddSync=true},markDelSync:function markDelSync(){this.tagDelSync=true},backup:function backup(){return{type:"Model",className:this.className,data:this.toArray()}},restore:function restore(bak){this.fromArray(bak.data)},restoreSync:function restore(bak){this.fromArray(bak.data);this.markAddSync()}};I.Util.define(Model.prototype,functions);I.Util.require("Model","Models",Model)}();!function(){var List=function List(){};var functions={init:function init(pk,list){if(pk===undefined)throw new I.Exception(10118);var attrs={pk:null,toAddList:[],toDelList:[],toUpdateList:[],toAddSyncList:[],toDelSyncList:[],toUpdateSyncList:[],tagDelSync:false};I.Util.define(this,attrs,true);this.setPK(pk);this.reset(list)},reset:function reset(list){list=list||{};this.toAddList=[];this.toDelList=[];this.toUpdateList=[];this.toAddSyncList=[];this.toDelSyncList=[];this.toUpdateSyncList=[];this.tagDelSync=
false;for(var i in list)this.set(list[i])},getPK:function getPK(){return this.pk},setPK:function setPK(pk){if(!I.Util.isUInt(pk))throw new I.Exception(10134);this.pk=pk},set:function set(child){var pk=child.getPK();if(!I.Util.isUInt(pk))throw new I.Exception(10132);this[pk]=child},get:function get(index){var child=this[index];if(!child)return null;return child},unset:function unset(input){var index;if(I.Util.isUInt(input))index=input;else if(input instanceof this.getChildModel())index=input.getPK();
else throw new I.Exception(10133);delete this[index]},add:function add(child){if(child instanceof this.getChildModel()===false)throw new I.Exception(10127);var childExists=this.get(child.getPK());if(childExists)throw new I.Exception(10140);this.toAddList.push(child)},del:function del(input){var index;if(I.Util.isUInt(input))index=input;else if(input instanceof this.getChildModel())index=input.getPK();else throw new I.Exception(10128);var child=this.get(index);if(child===null)throw new I.Exception(10129);
this.toDelList.push(child)},drop:function drop(){for(var i in this){this.toDelList.push(this[i]);delete this[i]}},update:function update(child){if(child instanceof this.getChildModel()===false)throw new I.Exception(10130);var index=child.getPK();var preChild=this.get(index);if(preChild===null)throw new I.Exception(10131);this.toUpdateList.push(child)},addSync:function addSync(child){if(child instanceof this.getChildModel()===false)throw new I.Exception(10135);var pk=child.getPK();if(pk===undefined)throw new I.Exception(10120);
var childExists=this.get(pk);if(childExists)throw new I.Exception(10141);this.toAddSyncList.push(pk);this.set(child)},delSync:function delSync(input){var index;if(I.Util.isUInt(input))index=input;else if(input instanceof this.getChildModel())index=input.getPK();else throw new I.Exception(10136);var child=this.get(index);if(child===null)throw new I.Exception(10137);var pos=this.toAddSyncList.indexOf(index);if(pos===-1){var updatePos=this.toUpdateSyncList.indexOf(index);if(updatePos!==-1)this.toUpdateSyncList.splice(updatePos,
1);this.toDelSyncList.push(child)}else this.toAddSyncList.splice(pos,1);this.unset(index)},dropSync:function dropSync(){for(var i in this){var pos=this.toAddSyncList.indexOf(i);if(pos===-1){var updatePos=this.toUpdateSyncList.indexOf(i);if(updatePos!==-1)this.toUpdateSyncList.splice(updatePos,1);this.toDelSyncList.push(this.get(i))}else this.toAddSyncList.splice(pos,1);delete this[i]}},updateSync:function updateSync(child){if(child instanceof this.getChildModel()===false)throw new I.Exception(10138);
var index=child.getPK();if(this.get(index)===null)throw new I.Exception(10139);var pos=this.toAddSyncList.indexOf(index);if(pos===-1)this.toUpdateSyncList.push(index);this.set(child)},markDelSync:function markDelSync(){this.tagDelSync=true},getKeys:function getKeys(){var keys=[];var util=I.Util;for(var i in this){i=util.isUInt(i)?parseInt(i):i;keys.push(i)}return keys},toAbbArray:function toAbbArray(filterOn){var toAbbArray={};for(var i in this)toAbbArray[i]=this[i].toAbbArray(filterOn);return toAbbArray},
toArray:function toArray(filterOn){var toArray={};for(var i in this)toArray[i]=this[i].toArray(filterOn);return toArray},fromAbbArray:function fromAbbArray(dataList,resetUpdateList){var child;var childModelClass=this.getChildModel();for(var i in dataList){child=new childModelClass;child.fromAbbArray(dataList[i],resetUpdateList);this.set(child)}},fromArray:function fromArray(dataList,resetUpdateList){var child;var childModelClass=this.getChildModel();for(var i in dataList){child=new childModelClass;
child.fromArray(dataList[i],resetUpdateList);this.set(child)}},last:function last(){return I.Util.last(this)},backup:function backup(){return{type:"List",className:this.className,pk:this.getPK(),data:this.toArray()}},restore:function restore(bak){var child;var childModelClass=this.getChildModel();for(var i in bak.data){child=new childModelClass;child.fromArray(bak.data[i]);this.add(child)}},restoreSync:function restoreSync(bak){var child;var childModelClass=this.getChildModel();for(var i in bak.data){child=
new childModelClass;child.fromArray(bak.data[i]);this.addSync(child)}}};I.Util.define(List.prototype,functions);I.Util.require("List","Models",List)}();!function(){if(!I.Util.isBrowser())var fs=require("fs");var Maker=function(){};Maker.prototype.makeModelBaseClasses=function makeModelBaseClasses(orms){this.checkModelAbbs(orms);this.classes={};this.indexedDBCallbacks=[];orms.forEach(function(orm){this.makeModelBaseClass(orm)}.bind(this))};Maker.prototype.makeModelBaseClass=function makeModelBaseClass(orm){this.makePKClass(orm);if(orm.storeType)this.makePKStoreClass(orm);this.makeModelClass(orm);if(orm.storeType)this.makeModelStoreClass(orm);if(orm.list){this.makeListClass(orm);
if(orm.storeType)this.makeListStoreClass(orm)}};Maker.prototype.checkModelAbbs=function checkModelAbbs(orms){var repeats={};var list;orms.forEach(function(orm){if(repeats[orm.abb])throw new I.Exception(10002);repeats[orm.abb]=true;if(orm.list){list=orm.abb+"l";if(repeats[list])throw new I.Exception(10002);repeats[list]=true}})};Maker.prototype.getClasses=function getClasses(){return this.classes};Maker.prototype.makePKClass=function makePKClass(orm){var Class=I.Util.createFn(orm.name+"PKBase",["pk"]);
Class.prototype=new I.Models.PK;var functions={constructor:Class,className:orm.name+"PK",getStore:function getStore(){return I.Models[orm.name+"PKStore"]}};I.Util.define(Class.prototype,functions);this.classes[orm.name+"PKBase"]=Class};Maker.prototype.makePKStoreClass=function makePKStoreClass(orm){var Class=I.Util.createFn(orm.name+"PKStoreBase");Class.prototype=new I.Models["PK"+orm.storeType+"Store"];var functions={constructor:Class,className:orm.name+"PKStore",key:I.Const.Frame.GLOBAL_KEY_PREFIX+
orm.abb,modelName:orm.name,getModel:function getModel(){return I.Models[orm.name+"PK"]}};I.Util.define(Class.prototype,functions);this.classes[orm.name+"PKStoreBase"]=Class};Maker.prototype.makeModelClass=function makeModelClass(orm){var abbs=this.makeAbbs(orm.column,[]);var Class=I.Util.createFn(orm.name+"Base",["args"]);Class.prototype=new I.Models.Model;var columns=[];var abbMap={};var fullMap={};orm.column.forEach(function(n,i){columns[i]={i:i,full:n,abb:abbs[n],toAdd:orm.toAddFilter.indexOf(i)!==
-1,toUpdate:orm.toUpdateFilter.indexOf(i)!==-1,toAbb:orm.toAbbFilter.indexOf(i)!==-1,toArray:orm.toArrayFilter.indexOf(i)!==-1};abbMap[abbs[n]]=columns[i];fullMap[n]=columns[i]});var functions={constructor:Class,className:orm.name,pk:orm.pk,getStore:function getStore(){return I.Models[orm.name+"Store"]},column:columns,abbMap:abbMap,fullMap:fullMap};I.Util.define(Class.prototype,functions);orm.column.forEach(function(v,i){Object.defineProperty(Class.prototype,v,{get:function(){return this.args[i]},
set:function(v){if(this.args[i]===v)return;this.args[i]=v;this.updateList[i]=1}})});this.classes[orm.name+"Base"]=Class};Maker.prototype.makeModelStoreClass=function makeModelStoreClass(orm){var Class=I.Util.createFn(orm.name+"StoreBase");Class.prototype=new I.Models["Model"+orm.storeType+"Store"];var functions={constructor:Class,className:orm.name+"Store",modelName:orm.name,pk:orm.pk,abb:orm.abb,pkAutoIncrement:orm.pkAutoIncrement,getModel:function getModel(){return I.Models[orm.name]}};I.Util.define(Class.prototype,
functions);this.classes[orm.name+"StoreBase"]=Class};Maker.prototype.makeListClass=function makeListClass(orm){var className=orm.name+"ListBase";var Class=I.Util.createFn(className,["pk","list"]);Class.prototype=new I.Models.List;var functions={constructor:Class,className:orm.list,childModelName:orm.name,getStore:function getStore(){return I.Models[this.className+"Store"]},getChildModel:function getChildModel(){return I.Models[this.childModelName]}};I.Util.define(Class.prototype,functions);this.classes[className]=
Class};Maker.prototype.makeListStoreClass=function makeListStoreClass(orm){var Class=I.Util.createFn(orm.list+"StoreBase");Class.prototype=new I.Models["List"+orm.storeType+"Store"];var functions={constructor:Class,className:orm.list+"Store",abb:orm.abb+"l",childModelName:orm.name,listModelName:orm.list,childStoreName:orm.name+"Store",getChildModel:function getChildModel(){return I.Models[orm.name]},getListModel:function getListModel(){return I.Models[orm.list]},getChildStore:function getChildStore(){return I.Models[orm.name+
"Store"]}};I.Util.define(Class.prototype,functions);this.classes[orm.list+"StoreBase"]=Class};Maker.prototype.makeAbbs=function makeAbbs(columns,filter){var abbs={};var i=0;columns.forEach(function(column){if(filter.indexOf(i)!==-1){++i;return}var candidateAbb=this.makeAbb(column);while(this.abbExist(candidateAbb,abbs))candidateAbb=this.renameAbb(candidateAbb);abbs[column]=candidateAbb;++i}.bind(this));return abbs};Maker.prototype.makeAbb=function makeAbb(full){return(full[0]+full.replace(/[a-z]/g,
"")).toLowerCase()};Maker.prototype.abbExist=function abbExist(abb,abbs){return I.Util.valueExist(abb,abbs)};Maker.prototype.renameAbb=function renameAbb(abb){return/^([a-zA-Z0-9]+?)(\d+)$/.test(abb)?RegExp.$1+(parseInt(RegExp.$2)+1):abb+1};Maker.prototype.createServerFiles=function createServerFiles(orms,dir){if(!fs.existsSync(dir))fs.mkdir(dir);orms.forEach(function(orm){this.createServerPKFile(orm,dir);this.createServerPKStoreFile(orm,dir);this.createServerModelFile(orm,dir);this.createServerModelStoreFile(orm,
dir);if(orm.list){this.createServerListFile(orm,dir);this.createServerListStoreFile(orm,dir)}}.bind(this))};Maker.prototype.createServerPKFile=function createServerPKFile(orm,dir){var pkName=orm.name+"PK";var content="/* This file is generated by IFramework - Maker.js for user to rewrite PK file */\n";content+="!function () {\n";content+="    var "+pkName+" = function "+pkName+"(pk) {\n";content+="        this.init.call(this, pk);\n";content+="    };\n";content+="\n";content+="    "+pkName+".prototype = new I.Models."+
pkName+"Base();\n";content+="    "+pkName+".prototype.constructor = "+pkName+";\n";content+="\n";content+="    I.Util.require('"+pkName+"', 'Models', "+pkName+");\n";content+="}();";this.writeFile(pkName+".js",content,dir,false)};Maker.prototype.createServerPKStoreFile=function createServerPKStoreFile(orm,dir){var pkStoreName=orm.name+"PKStore";var content="/* This file is generated by IFramework - Maker.js for user to rewrite PKStore file */\n";content+="!function () {\n";content+="    var "+pkStoreName+
" = function "+pkStoreName+"(db) {\n";content+="        this.db = db;\n";content+="    };\n";content+="\n";content+="    "+pkStoreName+".prototype = new I.Models."+pkStoreName+"Base();\n";content+="    "+pkStoreName+".prototype.constructor = "+pkStoreName+";\n";content+="\n";content+="    I.Util.require('"+pkStoreName+"', 'Models', new "+pkStoreName+"(db));\n";content+="}();";this.writeFile(pkStoreName+".js",content,dir,false)};Maker.prototype.createServerModelFile=function createServerModelFile(orm,
dir){var content="/* This file is generated by IFramework - Maker.js for user to rewrite Model file */\n";content+="!function () {\n";content+="    var "+orm.name+" = function "+orm.name+"(args) {\n";content+="        this.init.call(this, args);\n";content+="    };\n";content+="\n";content+="    "+orm.name+".prototype = new I.Models."+orm.name+"Base();\n";content+="    "+orm.name+".prototype.constructor = "+orm.name+";\n";content+="\n";content+="    I.Util.require('"+orm.name+"', 'Models', "+orm.name+
");\n";content+="}();";this.writeFile(orm.name+".js",content,dir,false)};Maker.prototype.createServerModelStoreFile=function createServerModelStoreFile(orm,dir){var storeName=orm.name+"Store";var content="/* This file is generated by IFramework - Maker.js for user to rewrite ModelStore file */\n";content+="!function () {\n";content+="    var "+storeName+" = function "+storeName+"(db) {\n";content+="        this.db = db;\n";content+="    };\n";content+="\n";content+="    "+storeName+".prototype = new I.Models."+
storeName+"Base();\n";content+="    "+storeName+".prototype.constructor = "+storeName+";\n";content+="\n";content+="    I.Util.require('"+storeName+"', 'Models', new "+storeName+"(db));\n";content+="}();";this.writeFile(storeName+".js",content,dir,false)};Maker.prototype.createServerListFile=function createServerListFile(orm,dir){var content="/* This file is generated by IFramework - Maker.js for user to rewrite List file */\n";content+="!function () {\n";content+="    var "+orm.list+" = function "+
orm.list+"(pk, list) {\n";content+="        this.init.call(this, pk, list);\n";content+="    };\n";content+="\n";content+="    "+orm.list+".prototype = new I.Models."+orm.list+"Base();\n";content+="    "+orm.list+".prototype.constructor = "+orm.list+";\n";content+="\n";content+="    I.Util.require('"+orm.list+"', 'Models', "+orm.list+");\n";content+="}();";this.writeFile(orm.list+".js",content,dir,false)};Maker.prototype.createServerListStoreFile=function createServerListStoreFile(orm,dir){var listStoreName=
orm.list+"Store";var content="/* This file is generated by IFramework - Maker.js for user to rewrite ListStore file */\n";content+="!function () {\n";content+="    var "+listStoreName+" = function "+listStoreName+"(db) {\n";content+="        this.db = db;\n";content+="    };\n";content+="\n";content+="    "+listStoreName+".prototype = new I.Models."+listStoreName+"Base();\n";content+="    "+listStoreName+".prototype.constructor = "+listStoreName+";\n";content+="\n";content+="    I.Util.require('"+
listStoreName+"', 'Models', new "+listStoreName+"(db));\n";content+="}();";this.writeFile(listStoreName+".js",content,dir,false)};Maker.prototype.createClientFiles=function createClientFiles(orms,dir){if(!fs.existsSync(dir))fs.mkdir(dir);orms.forEach(function(orm){this.createClientPKFile(orm,dir);this.createClientPKStoreFile(orm,dir);this.createClientModelFile(orm,dir);this.createClientModelStoreFile(orm,dir);if(orm.list){this.createClientListFile(orm,dir);this.createClientListStoreFile(orm,dir)}}.bind(this))};
Maker.prototype.createClientPKFile=function createClientPKFile(orm,dir){var pkName=orm.name+"PK";var content="/* This file is generated by IFramework - Maker.js for user to rewrite PK file */\n";content+="I.Loader.ModelQueue.push(function() {\n";content+="    var "+pkName+" = function "+pkName+"(pk) {\n";content+="        this.init.call(this, pk);\n";content+="    };\n";content+="\n";content+="    "+pkName+".prototype = new I.Models."+pkName+"Base();\n";content+="    "+pkName+".prototype.constructor = "+
pkName+";\n";content+="\n";content+="    I.Util.require('"+pkName+"', 'Models', "+pkName+");\n";content+="});";this.writeFile(pkName+".js",content,dir,false)};Maker.prototype.createClientPKStoreFile=function createClientPKStoreFile(orm,dir){var pkStoreName=orm.name+"PKStore";var content="/* This file is generated by IFramework - Maker.js for user to rewrite PKStore file */\n";content+="I.Loader."+orm.storeType+"Queue.push(function (db) {\n";content+="    var "+pkStoreName+" = function "+pkStoreName+
"(db) {\n";content+="        this.db = db;\n";content+="    };\n";content+="\n";content+="    "+pkStoreName+".prototype = new I.Models."+pkStoreName+"Base();\n";content+="    "+pkStoreName+".prototype.constructor = "+pkStoreName+";\n";content+="\n";content+="    I.Util.require('"+pkStoreName+"', 'Models', new "+pkStoreName+"(db));\n";content+="});";this.writeFile(pkStoreName+".js",content,dir,false)};Maker.prototype.createClientModelFile=function createClientModelFile(orm,dir){var content="/* This file is generated by IFramework - Maker.js for user to rewrite Model file */\n";
content+="I.Loader.ModelQueue.push(function () {\n";content+="    var "+orm.name+" = function "+orm.name+"(args) {\n";content+="        this.init.call(this, args);\n";content+="    };\n";content+="\n";content+="    "+orm.name+".prototype = new I.Models."+orm.name+"Base();\n";content+="    "+orm.name+".prototype.constructor = "+orm.name+";\n";content+="\n";content+="    I.Util.require('"+orm.name+"', 'Models', "+orm.name+");\n";content+="});";this.writeFile(orm.name+".js",content,dir,false)};Maker.prototype.createClientModelStoreFile=
function createClientModelStoreFile(orm,dir){var storeName=orm.name+"Store";var content="/* This file is generated by IFramework - Maker.js for user to rewrite ModelStore file */\n";content+="I.Loader."+orm.storeType+"Queue.push(function (db) {\n";content+="    var "+storeName+" = function "+storeName+"(db) {\n";content+="        this.db = db;\n";content+="    };\n";content+="\n";content+="    "+storeName+".prototype = new I.Models."+storeName+"Base();\n";content+="    "+storeName+".prototype.constructor = "+
storeName+";\n";content+="\n";content+="    I.Util.require('"+storeName+"', 'Models', new "+storeName+"(db));\n";content+="});";this.writeFile(storeName+".js",content,dir,false)};Maker.prototype.createClientListFile=function createClientListFile(orm,dir){var content="/* This file is generated by IFramework - Maker.js for user to rewrite List file */\n";content+="I.Loader.ModelQueue.push(function () {\n";content+="    var "+orm.list+" = function "+orm.list+"(pk, list) {\n";content+="        this.init.call(this, pk, list);\n";
content+="    };\n";content+="\n";content+="    "+orm.list+".prototype = new I.Models."+orm.list+"Base();\n";content+="    "+orm.list+".prototype.constructor = "+orm.list+";\n";content+="\n";content+="    I.Util.require('"+orm.list+"', 'Models', "+orm.list+");\n";content+="});";this.writeFile(orm.list+".js",content,dir,false)};Maker.prototype.createClientListStoreFile=function createClientListStoreFile(orm,dir){var listStoreName=orm.list+"Store";var content="/* This file is generated by IFramework - Maker.js for user to rewrite ListStore file */\n";
content+="I.Loader."+orm.storeType+"Queue.push(function (db) {\n";content+="    var "+listStoreName+" = function "+listStoreName+"(db) {\n";content+="        this.db = db;\n";content+="    };\n";content+="\n";content+="    "+listStoreName+".prototype = new I.Models."+listStoreName+"Base();\n";content+="    "+listStoreName+".prototype.constructor = "+listStoreName+";\n";content+="\n";content+="    I.Util.require('"+listStoreName+"', 'Models', new "+listStoreName+"(db));\n";content+="});";this.writeFile(listStoreName+
".js",content,dir,false)};Maker.prototype.writeFile=function writeFile(name,content,path,overwrite){var fullPath=path+"/"+name;if(!overwrite&&fs.existsSync(fullPath)){console.log(fullPath,"exists, skip!");return}fs.writeFileSync(fullPath,content);console.log(fullPath,"Done!")};I.Util.require("Maker","",new Maker)}();!function(){var WS=function WS(){this.connection=null;this.url="";this.protocol="";this.onopen=function(){};this.onerror=function(){};this.onclose=function(){};this.onmessage=function(){};this.start=function start(url,protocol,autoReconnectInterval){this.url=url;this.protocol=protocol;this.autoReconnectInterval=autoReconnectInterval;this.connect();return this};this.connect=function connect(){this.connection=new WebSocket(this.url,this.protocol);this.connection.onopen=function(){I.l6("Websocket Opened");
this.onopen()}.bind(this);this.connection.onerror=function(error){I.l3("Websocket Error",error);this.onerror()}.bind(this);this.connection.onclose=function(error){I.l4("Websocket Closed",error);this.onclose();if(this.autoReconnectInterval!==0)setTimeout(this.connect.bind(this),this.autoReconnectInterval)}.bind(this);this.connection.onmessage=function(message){var res=JSON.parse(message.data);if(res.r!==0)throw new I.Exception(res.r);var route=I.routes[res.a];I.l6("WS In api:",res.a,"code:",res.r,
"data:",res.d);I.Ctrl[route.ctrl+"Controller"]["on"+route.action](res.d)}};this.send=function send(api,param){if(this.connection.readyState!==WebSocket.OPEN){I.l4("Websocket Disconnected, cannot send message to server.");return}param=param||{};var req={a:api,p:param};this.connection.send(JSON.stringify(req))}};I.Util.require("WebSocket","",WS)}();!function(){var DataPool=function DataPool(){this.pool={};this.toDelPool={}};DataPool.prototype.makeKey=function makeKey(name,index){return name+"-"+index};DataPool.prototype.set=function set(name,index,model){this.pool[this.makeKey(name,index)]=model};DataPool.prototype.get=function get(name,index){return this.pool[this.makeKey(name,index)]};DataPool.prototype.unset=function unset(name,index){delete this.pool[this.makeKey(name,index)]};DataPool.prototype.reset=function reset(){this.pool={}};DataPool.prototype.sync=
function sync(){var StoreClass;for(var i in this.pool){var data=this.pool[i];if(data.getPK)I.l7("Update",data.className+" "+data.getPK());StoreClass=data.getStore();StoreClass.sync(data)}for(var j in this.toDelPool){var toDelData=this.toDelPool[j];StoreClass=toDelData.getStore();if(toDelData.getPK)I.l7("Delete",toDelData.className+" "+toDelData.getPK());StoreClass.sync(toDelData);delete this.toDelPool[j]}};DataPool.prototype.del=function del(name,index){var data=this.get(name,index);data.markDelSync();
this.toDelPool[this.makeKey(name,index)]=data;this.unset(name,index)};DataPool.prototype.drop=function drop(){for(var key in this.pool){var data=this.pool[key];data.markDelSync();this.toDelPool[key]=data;delete this.pool[key]}this.sync()};I.Util.require("DataPool","",DataPool)}();!function(){var LogicController=function LogicController(){this._cb=null;this._pipe=[];this._imports=[];this._exports=[];this._exported=[];this._data={};this._now=-1};LogicController.prototype.add=function add(params){var fn=params.fn;var name=typeof fn.name==="string"?fn.name:/function\s+([^\{\(\s]+)/.test(fn.toString())?RegExp["$1"]:"[Unknown]";if(this[name]);else this[name]=fn;this._pipe.push(name);params.imports=params.imports||{};params.exports=params.exports||{};this._imports.push(params.imports);
this._exports.push(params.exports);var exported={};for(var i in params.exports)exported[i]=0;this._exported.push(exported);return this};LogicController.prototype.cb=function cb(cb){if(this._cb===null)this._cb=cb;else this._cb(arguments)};LogicController.prototype.next=function next(){if(!this._now===-1)for(var i in this._exported[this._now])if(!this._exported[this._now][i])throw new I.Exception(10401);++this._now;var funcName=this._pipe[this._now];if(!funcName)return;var args=[];var exportsName;var imports=
this._imports[this._now]?this._imports[this._now]:{};for(var argName in imports)if(argName[0]==="_")args.push(this.get(argName.slice(1)));else args.push(imports[argName]);this[funcName].apply(this,args)};LogicController.prototype.set=function set(name,val){this._exported[this._now][name]=1;var exports=this._exports[this._now];if(exports[name])name=exports[name];this._data[name]=val};LogicController.prototype.get=function get(name){return this._data[name]};I.Util.require("LogicController","",LogicController)}();!function(){var Renderer={cachedTpl:{},make:function make(name,data){data=data||{};if(this.cachedTpl[name]===undefined){var jadeSrc=$.ajax({url:I.env.JADE.URI+name+".jade",async:false}).responseText;var fn=jade.compile(jadeSrc);this.cachedTpl[name]=fn}var html=this.cachedTpl[name](data);return html}};I.Util.require("Renderer","",Renderer)}();!function(){var FileSystem={saveLocal:function saveLocal(fileName,content){var blob=new Blob([content],{type:"application/octet-stream"});var url=webkitURL.createObjectURL(blob);var link=document.createElementNS("http://www.w3.org/1999/xhtml","a");link.href=url;link.download=fileName;var mouseEvent=document.createEvent("MouseEvents");mouseEvent.initMouseEvent("click",true,false,window,0,0,0,0,0,false,false,false,false,0,null);link.dispatchEvent(mouseEvent);setTimeout(function(){webkitURL.revokeObjectURL(url)},
1E3)},loadLocal:function loadLocal(file,cb){var reader=new FileReader;reader.onload=function(e){cb(this.result)};reader.readAsText(file)}};I.Util.require("FileSystem","",FileSystem)}();!function(){var Loader={ModelQueue:[],initModel:function initModel(){I.Maker.makeModelBaseClasses(I.orms);for(var i in I.Maker.classes)I.Models[i]=I.Maker.classes[i];this.ModelQueue.forEach(function(fn){fn()})},IndexedDBQueue:[],initIndexedDB:function initIndexedDB(cb){var env=I.env.IDB;if(!env.ENABLED)return;cb=cb||function(){};var idb=new I.Models.IndexedDB(env.NAME,env.VERSION);idb.regSuccessEvent(function(db){I.Maker.classes={};I.orms.forEach(function(orm){I.Maker.makePKStoreClass(orm);I.Maker.makeModelStoreClass(orm);
I.Maker.makeListStoreClass(orm)});for(var i in I.Maker.classes)I.Models[i]=I.Maker.classes[i];this.IndexedDBQueue.forEach(function(fn){fn(idb)})}.bind(this));idb.regSuccessEvent(cb);idb.regUpgradeEvent(function(db){idb.resetTable(db,I.Const.IDB.PK_TABLE,"name");I.orms.forEach(function(orm){if(orm.storeType!=="IndexedDB")return;idb.resetTable(db,orm.name,orm.pk,I.Const.IDB.LIST_COLUMN_NAME,false)})});I.idb=idb},initWebsocket:function initWebSocket(cb){var env=I.env.WS;if(!env.ENABLED)return;cb=cb||
function(){};var ws=(new I.WebSocket).start(env.URL,env.PROTOCOL,env.AUTO_RECONNECT_INTERVAL);ws.onopen=cb;I.ws=ws},mergeExceptionCodes:function mergeExceptionCodes(){var ExceptionCodes=I.Util.merge(I.ex,I.ExceptionCodes);I.ExceptionCodes=ExceptionCodes},init:function init(wsCallback,idbCallback){Loader.initModel();Loader.initWebsocket(wsCallback);Loader.initIndexedDB(idbCallback)}};Loader.mergeExceptionCodes();I.Util.require("Loader","",Loader)}();
