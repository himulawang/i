var fs = require('fs');
var Maker = function() {};

/* Loader */
Maker.prototype.loadOrms = function loadOrm(orms) {
    this.checkModelAbbs(orms);

    var self = this;
    this.classes = {};

    orms.forEach(function(orm) {
        self.loadOrm(orm);
    });
};

Maker.prototype.loadOrm = function loadOrm(orm) {
    this.makeObjectClass(orm);
    this.makeObjectModelClass(orm);
    if (orm.list) {
        this.makeListClass(orm);
        this.makeListModelClass(orm);
    }
};

Maker.prototype.checkModelAbbs = function checkModelAbbs(orms) {
    var repeats = {};
    var list;
    orms.forEach(function(orm) {
        if (repeats[orm.abb]) throw new I.Exception(10002);
        repeats[orm.abb] = true;

        if (orm.list) {
            list = repeats[orm.abb] + 'l';
            if (repeats[list]) throw new I.Exception(10002);
            repeats[list] = true;
        }
    });
};

Maker.prototype.getClasses = function getClasses() {
    return this.classes;
};

/* Maker */
Maker.prototype.makeObjectClass = function makeObjectClass(orm) {
    var abbs = this.makeAbbs(orm.column, orm.clientFilter);

    // class create
    var content = '';
    content += "this.pk = '" + orm.pk + "';\n";
    content += "this.column = " + JSON.stringify(orm.column) + ";\n";
    content += "this.abb = " + JSON.stringify(abbs) + ";\n";

    var Class = new Function('args', content);

    // extends
    Class.prototype = new I.Object();
    Class.prototype.constructor = Class;

    // getter & setter
    orm.column.forEach(function(v, i) {
        Object.defineProperty(
            Class.prototype,
            v,
            {
                get: function() { return this.args[i]; },
                set: function(v) { this.args[i] = v; this.updateList[i] = 1; }
            }
        );
    });

    this.classes[orm.name + 'Base'] = Class;
};

Maker.prototype.makeObjectModelClass = function makeObjectModelClass(orm) {
    // class create
    var content = '';
    content += "this.type = " + I.Const.OBJECT_TYPE_HASH + ";\n";
    content += "this.objectName = '" + orm.name + "';\n";
    content += "this.pk = '" + orm.pk + "';\n";
    content += "this.abb = '" + orm.abb + "';\n";
    content += "this.pkAutoIncrement = " + orm.pkAutoIncrement.toString() + ";\n";
    content += "this.updateFilter = " + JSON.stringify(orm.updateFilter) + ";\n";

    var Class = new Function(content);

    // extends
    Class.prototype = new I.Model();
    Class.prototype.constructor = Class;

    this.classes[orm.name + 'ModelBase'] = Class;
};

Maker.prototype.makeListClass = function makeListClass(orm) {
    // class create
    var content = '';

    var Class = new Function('pk', 'list', content);

    // extends
    Class.prototype = new I.List();
    Class.prototype.constructor = Class;

    this.classes[orm.name + 'ListBase'] = Class;
};

Maker.prototype.makeListModelClass = function makeListModelClass(orm) {
    // class create
    var content = '';
    content += "this.type = " + I.Const.OBJECT_TYPE_LIST + ";\n";
    content += "this.objectName = '" + orm.list + "';\n";
    content += "this.abb = '" + orm.abb + "l';\n";
    content += "this.child = '" + orm.name + "';\n";
    content += "this.childModel = '" + orm.name + "Model';\n";

    var Class= new Function(content);

    // extends
    Class.prototype = new I.Model();
    Class.prototype.constructor = Class;

    this.classes[orm.list + 'ModelBase'] = Class;
};

/* Abb */
Maker.prototype.makeAbbs = function makeAbbs(columns, filter) {
    var self = this;
    var abbs = {};
    var i = 0;
    columns.forEach(function(column) {
        // filter
        if (filter.indexOf(i) !== -1) {
            ++i;
            return;
        }

        var candidateAbb = self.makeAbb(column);
        while (self.abbExist(candidateAbb, abbs)) {
            candidateAbb = self.renameAbb(candidateAbb);
        }
        abbs[column] = candidateAbb;
        ++i;
    });

    return abbs;
};

Maker.prototype.makeAbb = function makeAbb(full) {
    return (full[0] + full.replace(/[a-z]/g, '')).toLowerCase();
};

Maker.prototype.abbExist = function abbExist(abb, abbs) {
    return I.Util.valueExist(abb, abbs);
};

Maker.prototype.renameAbb = function renameAbb(abb) {
    return /^([a-zA-Z0-9]+?)(\d+)$/.test(abb) ? RegExp.$1 + (parseInt(RegExp.$2) + 1) : abb + 1;
};

/* Creator */
Maker.prototype.createFiles = function createFiles(orms, dir) {
    var self = this;

    // check dir exist
    if (!fs.existsSync(dir)) {
        fs.mkdir(dir);
    }

    orms.forEach(function(orm) {
        self.createObjectFile(orm, dir);
        self.createObjectModelFile(orm, dir);
        if (orm.list) {
            self.createListFile(orm, dir);
            self.createListModelFile(orm, dir);
        }
    });
};

Maker.prototype.createObjectFile = function createObjectFile(orm, dir) {
    var content = "/* This file is generated by IFramework - Maker.js for user to rewrite Model file */\n";
    content += "var " + orm.name + " = function " + orm.name + "(args) {\n";
    content += "    this.init.call(this, args);\n";
    content += "};\n";
    content += "\n";

    // extends
    content += orm.name + ".prototype = new " + orm.name + "Base();\n";
    content += orm.name + ".prototype.constructor = " + orm.name + ";\n";

    // exports
    content += "exports." + orm.name + " = " + orm.name + ";";

    this.writeFile(orm.name + '.js', content, dir, false);
};

Maker.prototype.createObjectModelFile = function createObjectModelFile(orm, dir) {
    var modelName = orm.name + 'Model';
    var content = "/* This file is generated by IFramework - Maker.js for user to rewrite Model file */\n";
    content += "var " + modelName + " = function " + modelName + "() {\n";
    content += "};\n";
    content += "\n";

    // extends
    content += modelName + ".prototype = new " + modelName + "Base();\n";
    content += modelName + ".prototype.constructor = " + modelName + ";\n";

    // exports
    content += "exports." + modelName + " = new " + modelName + "();";

    this.writeFile(modelName + '.js', content, dir, false);
};

Maker.prototype.createListFile = function createListFile(orm, dir) {
    var content = "/* This file is generated by IFramework - Maker.js for user to rewrite Model file */\n";
    content += "var " + orm.list + " = function " + orm.list + "(pk, list) {\n";
    content += "    this.init.call(this, pk, list);\n";
    content += "};\n";
    content += "\n";

    // extends
    content += orm.list + ".prototype = new " + orm.list + "Base();\n";
    content += orm.list + ".prototype.constructor = " + orm.list + ";\n";

    // exports
    content += "exports." + orm.list + " = " + orm.list + ";";

    this.writeFile(orm.list + '.js', content, dir, false);
};

Maker.prototype.createListModelFile = function createListModelFile(orm, dir) {
    var modelName = orm.list + 'Model';
    var content = "/* This file is generated by IFramework - Maker.js for user to rewrite Model file */\n";
    content += "var " + modelName + " = function " + modelName + "() {\n";
    content += "};\n";
    content += "\n";

    // extends
    content += modelName + ".prototype = new " + modelName + "Base();\n";
    content += modelName + ".prototype.constructor = " + modelName + ";\n";

    // exports
    content += "exports." + modelName + " = new " + modelName + "();";

    this.writeFile(modelName + '.js', content, dir, false);
};

/* File System*/
Maker.prototype.writeFile = function writeFile(name, content, path, overwrite) {
    var fullPath = path + '/' + name;

    if (!overwrite && fs.existsSync(fullPath)) {
        console.log(fullPath, 'exists, skip!');
        return;
    }

    fs.writeFileSync(fullPath, content);
    console.log(fullPath, 'Done!');
};

exports.Maker = new Maker();
